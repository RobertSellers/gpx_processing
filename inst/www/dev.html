<!DOCTYPE html>
<html lang="en">
<head>
<title>GPX QA and Analysis</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- styles -->
<link href="scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="scripts/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" media="screen">
<link href="scripts/jqueryui/css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet" media="screen">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/buttons/1.5.1/css/buttons.dataTables.min.css" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.12/css/jquery.dataTables.css">

<!-- libraries -->
<script src="scripts/jquery-1.10.2.min.js"> </script>
<script src="scripts/opencpu-0.4.js"> </script>
<script src="scripts/bootstrap/js/bootstrap.js"> </script>
<script src="scripts/jqueryui/jquery-ui-1.10.3.custom.js"> </script>
<script src="scripts/knockout-min.js"></script>
<script src="scripts/ko.plus.js"></script>
<script src="scripts/leaflet.js"></script>
<script src="scripts/gpx.js"></script>
<script src="scripts/jquery.dataTables.min.js"></script>
<script src="scripts/dataTables.buttons.min.js"></script>
<script src="scripts/dataTables.flash.min.js"></script>
<script src="scripts/jszip.min.js"></script>
<script src="scripts/pdfmake.min.js"></script>
<script src="scripts/vfs_font.js"></script>
<script src="scripts/buttons.html5.min.js"></script>
<script src="scripts/buttons.print.min.js"></script>

<script type="text/javascript">

$(document).ready(function() {

  // var viewModel = {
  //     session_tmp: ko.observable(),
  //     gpx_file: ko.observable(),
  //     gpx_file_name: ko.observable(),
  //     leafletMap: ko.observable(),
  //     rDataOutput: ko.observable()
  // };

  function viewModel() {
      this.session_tmp = ko.observable(),
      this.gpx_file= ko.observable(),
      this.gpx_file_name= ko.observable(),
      this.leafletMap= ko.observable(),
      this.rDataOutput= ko.observable(),
      this.doSomething = ko.command(function() {
          // return $.get("...");
      })
      .done(function(data) {
          //do something with the response
      })
      .fail(function(error) {
          //handle the error
      });
  }

  var instance = new viewModel();

  //Display if dev.html or not
  var cur_url = window.location.href.split(/[\\\/]/)[window.location.href.split(/[\\\/]/).length-1]
  if(cur_url == "dev.html"){
    $("#dev_check").html(cur_url);
  }

  $("#process_data").attr("disabled", "disabled");
  $("#session_url").attr("disabled", "disabled");

  //automatically upload GPX file on change.
  $("#gpxfile").on("change", function(){

  //verify that a file is selected
  if($("#gpxfile")[0].files[0]){

      $("#successdiv").empty();
      $("#errordiv").empty()

      //////////////////////////////
      //Upload and validate the data
      //////////////////////////////

    //Save filename
    viewModel.gpx_file_name($("#gpxfile")[0].files[0].name)

      var req = ocpu.call("gpx_validation", {
          gpxfile : $("#gpxfile")[0].files[0]
      }, function(session){
          viewModel.session_tmp(session.getLoc())

         //retrieve javascript object as json
         session.getObject(function(data)  {
            viewModel.rDataOutput(data)
          });

          //refresh the map
          try{
            viewModel.leafletMap().off()
            viewModel.leafletMap().remove()
          }catch(err){
            //do nothing for the moment
          }
          
          $("#session_url").removeAttr("disabled");
          $("#session_url").attr("href", session.getLoc()).attr("target","_blank")
          $("#process_data").removeAttr("disabled");
          $("#step_2").css("opacity", 1);

          successmsg("GPX file successfully loaded!");

      }).fail(function(jqXHR){
          $("#step_2").css("opacity", 0.2);
          errormsg(jqXHR.responseText);
      }).always(function(){
          var session_url = document.getElementById("session_url");
          session_url.style.cursor = "pointer";
    });
    }
});

//R output to popup
function successmsg(text){
    $("#successdiv").empty().append('<div class="alert alert-success alert-dismissable"><a href="#" class="close" data-dismiss="alert">&times;</a>' + text + '</div>');
}

//R output to popup
function errormsg(text){
    $("#convert_button").attr("disabled", "disabled");
    $("#errordiv").empty().append('<div class="alert alert-danger alert-dismissable"><a href="#" class="close" data-dismiss="alert">&times;</a>' + text + '</div>');
}


$(function(){
  $("#process_data").on("click", function(){
    $("#process_data").attr("disabled", "disabled");
    //////////////////////////////
    //Plot Preview Map
    //////////////////////////////

    //Retrieve saved GPX
    var gpx = viewModel.session_tmp() +'files/'+ viewModel.gpx_file_name(); 

    var map = L.map('plotdiv');
    L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

    new L.GPX(gpx, {async: true}).on('loaded', function(e) {
      map.fitBounds(e.target.getBounds());
    }).addTo(map);

    viewModel.leafletMap(map)

    //////////////////////////////
    //Data Table
    //////////////////////////////


    $('#gpx_processed').dataTable({
      dom: 'Bfrtip',
      data: viewModel.rDataOutput(),
      searching: false,
      columns: [
        {"data": "DateTime", title: "DateTime"},
        {"data":  "Dist", title: "Dist"},
        {"data":  "Dist2D", title: "Dist2D"},
        {"data":  "East", title: "East"},
        {"data":  "Elevation", title: "Elevation"},
        {"data":  "Gradient", title: "Gradient"},
        {"data":  "Latitude", title: "Latitude"},
        {"data":  "Longitude", title: "Longitude"},
        {"data":  "North", title: "North"},
        {"data":  "Pace", title: "Pace"},
        {"data":  "Seconds", title: "Seconds"},
        {"data":  "Speed", title: "Speed"},
        {"data":  "dDist", title: "dDist"},
        {"data":  "dDist2D", title: "dDist2D"},
        {"data":  "dEast", title: "dEast"},
        {"data":  "dNorth", title: "dNorth"},
        {"data":  "dUp", title: "dUp"}
        ],
      buttons: [
          {
            extend: 'collection',
            text: 'Export',
            buttons: [ 'pdfHtml5', 'csvHtml5', 'copyHtml5', 'excelHtml5' ]
          }
        ]
      });
  });
});



  $(document).ajaxStart(function() {
    $(".progress").show();
  });

  $(document).ajaxStop(function() {
    $(".progress").hide();
  });

});

</script>

<link href="styles/bootstrap_two_panel.css" rel="stylesheet" type="text/css">

</head>

  <body>
    <div class="flex-container">
      <div class="flex-item well" id="user_input_panel">
        <div id="project_title">
          GPX QA v1.10
        </div>
        <div id="credits">
          by <a href="http://www.azimuth1.com">Robert Sellers/Azimuth1</a>
        </div>
        <form enctype="multipart/form-data" id="uploadform" name="uploadform" role="form">
          <fieldset id="step_1">
            <legend class="custom_legend">(1) Load GPX data</legend>
            <div class="form-group">
              <input id="gpxfile" type="file">
            </div>
          </fieldset>
          <fieldset id="step_2">
            <legend class="custom_legend">(2a) Preview Data</legend>
            <div class="form-group">
              <label>Show map/table</label> <button disabled="disabled" id="process_data" type="button">Click</button><br>
            </div>
          </fieldset>
        </form>
        <div id='env_wrapper'>
            <a id="session_url">Session URL</a>
            <div id="dev_check"></div>
          </div>
      </div>
      <div class="flex-item well" id="plotdiv"></div>
      <div class="flex-item well" id="gpxTable">
          <table id="gpx_processed" class="display" cellspacing="0">
          </table>
        </div>
    </div>
      <!-- R Relayed Message and Progress Information -->
    <div id="azimuth_warning">
      <div id="successdiv"></div>
      <div id="errordiv"></div>
      <div class="progress progress-striped active">
        <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="45" class="progress-bar" role="progressbar" style="width: 100%"></div>
      </div>
    </div>
  </body>
</html>
