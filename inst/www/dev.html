<!DOCTYPE html>
<html lang="en">
<head>
<title>GPX - QA and Analysis</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- styles -->
<link href="scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="scripts/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" media="screen">
<link href="scripts/jqueryui/css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet" media="screen">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/buttons/1.5.1/css/buttons.dataTables.min.css" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.12/css/jquery.dataTables.css">
<link href="css/main.css" rel="stylesheet">

<!-- libraries -->
<script src="scripts/jquery-1.10.2.min.js"> </script>
<script src="scripts/opencpu-0.4.js"> </script>
<script src="scripts/bootstrap/js/bootstrap.js"> </script>
<script src="scripts/jqueryui/jquery-ui-1.10.3.custom.js"> </script>
<script src="scripts/knockout-min.js"></script>
<script src="scripts/leaflet.js"></script>
<script src="scripts/gpx.js"></script>
<script src="scripts/jquery.dataTables.min.js"></script>
<script src="scripts/dataTables.buttons.min.js"></script>
<script src="scripts/dataTables.flash.min.js"></script>
<script src="scripts/pdfmake.min.js"></script>
<script src="scripts/vfs_font.js"></script>
<script src="scripts/buttons.html5.min.js"></script>
<script src="scripts/buttons.print.min.js"></script>
<script src="js/main.js"></script>

<script type="text/javascript">

$(document).ready(function() {

  var viewModel = {
    session_tmp: ko.observable(),
    gpx_file_name: ko.observable(),
    leafletMap: ko.observable(),
    rDataOutput: ko.observable(),
    //gpx.js output data
    get_name: ko.observable(),//returns the name of the GPX track
    get_distance_imp: ko.observable(),//returns the total track distance in miles
    get_start_time: ko.observable(),//returns a Javascript Date object representing the starting time
    get_time_zone: ko.observable(),
    get_start_date: ko.observable(),
    get_moving_time: ko.observable(),//returns the moving time, in milliseconds
    get_total_time: ko.observable(),//returns the total track time, in milliseconds
    get_moving_pace_imp: ko.observable(),//returns the average moving pace in milliseconds per hour
    get_moving_speed_imp: ko.observable(),//returns the average moving speed in miles per hour
    get_total_speed_imp: ko.observable(),//returns the average total speed in miles per hour
    get_elevation_min_imp: ko.observable(),// returns the lowest elevation, in feet
    get_elevation_max_imp: ko.observable(),// returns the highest elevation, in feet
    get_elevation_gain_imp: ko.observable(),// returns the cumulative elevation gain, in feet
    get_elevation_loss_imp: ko.observable(),//returns the cumulative elevation loss, in feet
    //full elevation, cadence  data
    get_elevation_data_imp: ko.observable(),
    get_cadence_data_imp: ko.observable()
  };

  function clearData(){
    $('#step_2').css("opacity", 0.2);
    $('#plotdiv').css("opacity", 0.2);
    $('#gpxTable').css("opacity", 0.2);
    viewModel.leafletMap().eachLayer(function (layer) {
      // if (layer._url!='http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}'){
      if (layer.hasOwnProperty('_gpx')){
        viewModel.leafletMap().removeLayer(layer);
        viewModel.leafletMap().setView([37.8, -96], 4);
      }
    });
    map_lock('lock')
    viewModel.get_name(null);
    viewModel.get_distance_imp(null);
    viewModel.get_start_time(null);
    viewModel.get_time_zone(null);
    viewModel.get_start_date(null);
    viewModel.get_moving_time(null);
    viewModel.get_total_time(null);
    viewModel.get_moving_pace_imp(null);
    viewModel.get_moving_speed_imp(null);
    viewModel.get_total_speed_imp(null);
    viewModel.get_elevation_min_imp(null);
    viewModel.get_elevation_max_imp(null);
    viewModel.get_elevation_gain_imp(null);
    viewModel.get_elevation_loss_imp(null);
    viewModel.get_elevation_data_imp(null);
    viewModel.get_cadence_data_imp(null);
  }

  Object.prototype.hasOwnProperty = function(property) {
      return this[property] !== undefined;
  };

  function map_lock(toggle){
    if (toggle=='unlock'){
      viewModel.leafletMap().dragging.enable();
      viewModel.leafletMap().touchZoom.enable();
      viewModel.leafletMap().doubleClickZoom.enable();
      viewModel.leafletMap().scrollWheelZoom.enable();
      viewModel.leafletMap().boxZoom.enable();
      viewModel.leafletMap().keyboard.enable();
      if (viewModel.leafletMap().tap) viewModel.leafletMap().tap.enable();
      document.getElementById('plotdiv').style.cursor='grab';
    }if (toggle=='lock'){
      viewModel.leafletMap().dragging.disable();
      viewModel.leafletMap().touchZoom.disable();
      viewModel.leafletMap().doubleClickZoom.disable();
      viewModel.leafletMap().scrollWheelZoom.disable();
      viewModel.leafletMap().boxZoom.disable();
      viewModel.leafletMap().keyboard.disable();
      if (viewModel.leafletMap().tap) viewModel.leafletMap().tap.disable();
      document.getElementById('plotdiv').style.cursor='default';
    }
  }

  function msToTime(duration) {
    var milliseconds = parseInt((duration%1000)/100),
    seconds = parseInt((duration/1000)%60),
    minutes = parseInt((duration/(1000*60))%60),
    hours = parseInt((duration/(1000*60*60))%24);

    hours = (hours < 10) ? "0" + hours : hours;
    minutes = (minutes < 10) ? "0" + minutes : minutes;
    seconds = (seconds < 10) ? "0" + seconds : seconds;

    return hours + ":" + minutes + ":" + seconds + "." + milliseconds;
  }

  initDT({}, false)
  //Display if dev.html or not
  var cur_url = window.location.href.split(/[\\\/]/)[window.location.href.split(/[\\\/]/).length-1]
  if(cur_url == "dev.html"){
    $("#dev_check").html(cur_url);
  }

  $("#process_data").attr("disabled", "disabled");
  $('.dt-button').attr("disabled", "disabled");
  $("#session_url").attr("disabled", "disabled");

  $('#step_2').css("opacity", 0.2);
  $('#plotdiv').css("opacity", 0.2);
  $('#gpxTable').css("opacity", 0.2);

  //initialize leaflet map
  var map = L.map('plotdiv');
    L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);
    map.setView([37.8, -96], 4);

  viewModel.leafletMap(map)
  map_lock('lock')

  //automatically upload GPX file on change.
  $("#gpxfile").on("change", function(){

  //verify that a file is selected
  if($("#gpxfile")[0].files[0]){
    clearData()
    $("#successdiv").empty().show();
    $("#errordiv").empty().show();

    //////////////////////////////
    //Upload and validate the data
    //////////////////////////////

  viewModel.gpx_file_name($("#gpxfile")[0].files[0].name)

    var req = ocpu.call("gpx_validation", {
        gpxfile : $("#gpxfile")[0].files[0]
    }, function(session){
        viewModel.session_tmp(session.getLoc())

        //retrieve javascript object as json
        session.getObject(function(data)  {
          viewModel.rDataOutput(data)
          $("#session_url").removeAttr("disabled");
          $("#session_url").attr("href", session.getLoc()).attr("target","_blank")
          $("#process_data").removeAttr("disabled");

          $('#step_2').css("opacity", 1);
          $('#plotdiv').css("opacity", 1);

          successmsg("GPX file successfully loaded!");
          //refresh the map

          viewModel.leafletMap().eachLayer(function (layer) {
            if (layer.hasOwnProperty('_gpx')){
              viewModel.leafletMap().removeLayer(layer);
            }
          });
          //load gpx
          var gpx_file = session.getLoc() +'files/'+ viewModel.gpx_file_name(); 
          var gpxLayer = new L.GPX(gpx_file, {async: true})

          gpxLayer.on('loaded', function(e) {
            map.fitBounds(e.target.getBounds());
            viewModel.get_name(e.target.get_name())//returns the name of the GPX track
            viewModel.get_distance_imp(e.target.get_distance_imp().toFixed(2) + ' mi')//returns the total track distance in miles
            // viewModel.get_time_zone(e.target.get_start_time().getTimezoneOffset())//returns a Javascript Date object representing the starting time
            viewModel.get_start_date(e.target.get_start_time().toDateString())//returns a Javascript Date object representing when the last point was recorded
            viewModel.get_start_time(e.target.get_start_time().toLocaleTimeString())//returns a Javascript Date object representing when the last point was recorded
            viewModel.get_moving_time(msToTime(e.target.get_moving_time()))//returns the moving time, in milliseconds
            viewModel.get_total_time(msToTime(e.target.get_total_time()))//returns the total track time, in milliseconds
            // viewModel.get_moving_pace_imp(e.target.get_moving_pace_imp())//returns the average moving pace in milliseconds per hour
            viewModel.get_moving_speed_imp(e.target.get_moving_speed_imp().toFixed(2)+' mph')//returns the average moving speed in miles per hour
            viewModel.get_total_speed_imp(e.target.get_total_speed_imp().toFixed(2) + ' mph')//returns the average total speed in miles per hour
            viewModel.get_elevation_min_imp(e.target.get_elevation_min_imp().toFixed(2) + "'")// returns the lowest elevation, in feet
            viewModel.get_elevation_max_imp(e.target.get_elevation_max_imp().toFixed(2) + "'")// returns the highest elevation, in feet
            viewModel.get_elevation_gain_imp(e.target.get_elevation_gain_imp().toFixed(2) + "'")// returns the cumulative elevation gain, in feet
            viewModel.get_elevation_loss_imp(e.target.get_elevation_loss_imp().toFixed(2) + "'")//returns the cumulative elevation loss, in feet
            //full elevation, heartrate, cadence and temperature data
            viewModel.get_elevation_data_imp(e.target.get_elevation_data_imp())
            viewModel.get_cadence_data_imp(e.target.get_cadence_data_imp())
          }).addTo(viewModel.leafletMap());
          map_lock('unlock')
        });

      }).fail(function(jqXHR){
        clearData()
        errormsg(jqXHR.responseText);
      }).always(function(){
        var session_url = document.getElementById("session_url");
        session_url.style.cursor = "pointer";
        initDT({}, true) //clear datatable
    });
  }
});

//R output to popup
function successmsg(text){
  $("#successdiv").empty().append('<div class="alert alert-success alert-dismissable"><a href="#" class="close" data-dismiss="alert">&times;</a>' + text + '</div>');

  // setTimeout(function(){ 
  //   $("#successdiv").fadeOut( "slow", function() {
  //       // Animation complete.
  //     });
  // }, 5000 );
}

//R output to popup
function errormsg(text){
    $("#errordiv").empty().append('<div class="alert alert-danger alert-dismissable"><a href="#" class="close" data-dismiss="alert">&times;</a>' + text + '</div>');

  //   setTimeout(function(){ 
  //     $("#errordiv").fadeOut( "slow", function() {
  //        // Animation complete.
  //     });
  // }, 5000 );
}

function initDT(data , update){

  if(update){
    var datatable = $('#gpxDataTable').DataTable();
      datatable.clear();
      datatable.rows.add(data);
      datatable.draw();

  }else{
    $('#gpxDataTable').dataTable({
      dom: 'Bfrtip',
      data: data,
      searching: false,
      pageLength: 5,
      columns: [
        {"data": "DateTime", title: "DateTime"},
        {"data":  "Dist", title: "Dist"},
        // {"data":  "Dist2D", title: "Dist2D"},
        // {"data":  "East", title: "East"},
        {"data":  "Elevation", title: "Elevation"},
        {"data":  "Gradient", title: "Gradient"},
        {"data":  "Latitude", title: "Latitude"},
        {"data":  "Longitude", title: "Longitude"},
        // {"data":  "North", title: "North"},
        {"data":  "Pace", title: "Pace"},
        {"data":  "Seconds", title: "Seconds"},
        {"data":  "Speed", title: "Speed"},
        {"data":  "dDist", title: "dDist"},
        // {"data":  "dDist2D", title: "dDist2D"},
        // {"data":  "dEast", title: "dEast"},
        // {"data":  "dNorth", title: "dNorth"},
        // {"data":  "dUp", title: "dUp"}
        ],
      buttons: [
          {
            extend: 'collection',
            text: 'Export',
            buttons: [ 'pdfHtml5', 'csvHtml5', 'copyHtml5', 'excelHtml5' ]
          }
        ]
      });
    }
}

  //////////////////////////////
  //Process Data Table
  //////////////////////////////
  $(function(){
    $("#process_data").on("click", function(){
      $('#gpxTable').css("opacity", 1);
      $(".dt-button").removeAttr("disabled");
      $("#process_data").attr("disabled", "disabled");
        initDT(viewModel.rDataOutput(), true)
    });
  });

  //////////////////////////////
  //Ajax spinLoad Bar
  //////////////////////////////

  $(document).ajaxStart(function() {
    $(".spinLoad").show();
  });

  $(document).ajaxStop(function() {
    $(".spinLoad").hide();
  });

  ko.applyBindings(viewModel)

});

</script>

</head>

  <body>
    <header class="masthead" role="banner">
      <strong class="logo">
        <img class="logo-img logo-img-small" src="img/logo-small.svg" alt="Space Control">
        <img class="logo-img logo-img-big" src="img/logo.svg" alt="Space Control">
      </strong>
      <h1 class="title">Probes</h1>
      <nav class="nav-wrap" role="navigation">
        <button class="nav-btn" aria-controls="nav" aria-expanded="false"><i class="nav-icon">Toggle Navigation</i></button>
        <ul class="nav" id="nav" aria-hidden="true">
          <li>
            <span class="nav-label"><span class="nav-label-back">Spacecraft</span></span>
            <ol>
              <li><a href="#">GSLV</a></li>
              <li><a href="#">Saturn V</a></li>
              <li><a href="#">Shenzhou</a></li>
              <li><a href="#">Space Shuttle</a></li>
              <li><a href="#">Soyuz</a></li>
            </ol>
          </li>
          <li>
            <span class="nav-label"><span class="nav-label-back">Stations</span></span>
            <ol>
              <li><a href="#">ISS</a></li>
              <li><a href="#">Mir</a></li>
              <li><a href="#">Skylab</a></li>
            </ol>
          </li>
          <li>
            <span class="nav-label"><span class="nav-label-back">Satellites</span></span>
            <ol>
              <li><a href="#">Gaia</a></li>
              <li><a href="#">Hubble</a></li>
              <li><a href="#">Kepler</a></li>
            </ol>
          </li>
          <li>
            <span class="nav-label"><span class="nav-label-back">Rovers</span></span>
            <ol>
              <li><a href="#">Curiosity</a></li>
              <li><a href="#">Pathfinder</a></li>
              <li><a href="#">Sojourner</a></li>
            </ol>
          </li>
          <li>
            <span class="nav-label"><span class="nav-label-back">Probes</span></span>
            <ol>
              <li><a href="#">Dawn</a></li>
              <li><a href="#">Hayabusa</a></li>
              <li><a href="#">New Horizons</a></li>
              <li><a href="#">Rosetta</a></li>
              <li><a href="#">Voyageur 1</a></li>
            </ol>
          </li>
        </ul>
      </nav>
    </header>
  
    <main role="main">
  
      <article class="panel farthest">
        <h2 class="panel-head section-label" tabindex="0"><span class="section-label-back">Farthest distance</span></h2>
        <div class="farthest-wrap">
          <p class="farthest-km"><strong id="length" data-max="19692258000">19 692 258 000 km</strong></p>
          <p class="farthest-probe">Voyageur 1</p>
        </div>
      </article>
  
      <article class="panel distances">
        <h2 class="panel-head section-label" tabindex="0"><span class="section-label-back">Probe distances</span></h2>
        <div>
          <svg class="bar-chart" viewBox="0 0 1000 821.8">
            <title>Distances of farthest probes from Earth.</title>
            <style>
              .st0{fill:#6c8fe0;} .st1{fill:#6c8fe0;} .st2{fill:#6c8fe0;} .st3{fill:#6c8fe0;} .st4{fill:#fff;font-family:Ubuntu} .st5{font-size:52.7692px;} .st6{font-size:37.6923px;} .st7{font-size:40.2051px;} .st8{fill:none;stroke:#233e75;stroke-width:5;}
            </style>
            <g class="bar-wrap">
              <path id="bar-voy-1" d="M765.6 422.2h199v30.6h-199z" class="bar st0"/>
            </g>
            <g class="bar-wrap">
              <path id="bar-voy-2" d="M546.7 347.8h199v105h-199z" class="bar st1"/>
            </g>
            <g class="bar-wrap">
              <path id="bar-nh" d="M327.7 94h199v358.7h-199z" class="bar st2"/>
            </g>
            <g class="bar-wrap">
              <path id="bar-cas" d="M108.8 22.5h199v430.2h-199z" class="bar st3"/>
            </g>
            <text transform="matrix(0 -1 1 0 204.475 739.456)">
              <tspan x="0" y="0" class="st4 st5">Voyageur 1</tspan><tspan x="84" y="45.2" class="st4 st6">19.86 B km</tspan>
            </text>
            <text transform="matrix(0 -1 1 0 427.26 739.456)">
              <tspan x="0" y="0" class="st4 st5">Voyageur 2</tspan><tspan x="84" y="45.2" class="st4 st6">16.41 B km</tspan>
            </text>
            <text transform="matrix(0 -1 1 0 646.202 800.298)">
              <tspan x="0" y="0" class="st4 st5">New Horizons</tspan><tspan x="187.4" y="45.2" class="st4 st6">4.8 B km</tspan>
            </text>
            <text transform="matrix(0 -1 1 0 865.145 631.651)">
              <tspan x="0" y="0" class="st4 st5">Cassini</tspan><tspan x="-2.5" y="45.2" class="st4 st6">1.43 B km</tspan>
            </text>
            <text transform="translate(32.675 467.33)" class="st4 st7" aria-hidden="true">0</text>
            <text transform="translate(10 248.72)" class="st4 st7" aria-hidden="true">10</text>
            <path d="M83.5 452.8H990" class="st8"/>
            <path d="M83.5 452.8V22.5" class="st8"/>
            <path d="M83.5 452.8H65" class="st8"/>
            <path d="M83.5 234.2H65" class="st8"/>
          </svg>
        </div>
      </article>
  
      <article class="panel">
        <h2 class="panel-head section-label" tabindex="0"><span class="section-label-back">Probe details</span></h2>
        <div class="table-wrap">
          <table>
            <caption>Probe details including launch date &amp; destination.</caption>
            <thead>
              <tr>
                <th scope="col">Probe</th>
                <th scope="col">Launch date</th>
                <th scope="col">Destination</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">Juno</th>
                <td><time datetime="2011-08-05">Aug. 5, 2011</time></td>
                <td>Jupiter</td>
              </tr>
              <tr>
                <th scope="row">Rosetta</th>
                <td><time datetime="2004-03-02">Mar. 2, 2004</time></td>
                <td>Comet 67P/Churyumov-Gerasimenko</td>
              </tr>
              <tr>
                <th scope="row">Okras</th>
                <td><time datetime="2010-05-20">May 20, 2010</time></td>
                <td>Venus</td>
              </tr>
              <tr>
                <th scope="row">Shin’en 2</th>
                <td><time datetime="2014-12-03">Dec. 3, 2014</time></td>
                <td>Heliocentric orbit</td>
              </tr>
              <tr>
                <th scope="row">Gaia</th>
                <td><time datetime="2013-12-19">Dec. 19, 2013</time></td>
                <td>Sun-Earth L2 point</td>
              </tr>
            </tbody>
          </table>
        </div>
      </article>
  
      <article class="panel">
        <h2 class="panel-head section-label" tabindex="0"><span class="section-label-back">Probe destination</span></h2>
  
        <div class="tab-group">
          <ul class="tabs clearfix" role="tablist">
            <li class="tab" role="presentation"><a href="#pluto" role="tab" aria-controls="pluto" aria-selected="true">Pluto</a></li>
            <li class="tab" role="presentation"><a href="#67pcg" role="tab" aria-controls="67pcg">67P/C-G</a></li>
            <li class="tab" role="presentation"><a href="#jupiter" role="tab" aria-controls="jupiter">Jupiter</a></li>
          </ul>
  
          <div class="tab-panels">
            <div class="tab-panel" id="pluto" role="tabpanel" aria-hidden="false">
              <img class="flex-img details-img" src="img/pluto.jpg" alt="Composite photo of Pluto taken by New Horizons">
              <dl class="details">
                <dt>Name</dt>
                <dd>Pluto</dd>
                <dt>Discovery year</dt>
                <dd>1930</dd>
                <dt>Discovered by</dt>
                <dd>Clyde W. Tombaugh</dd>
              </dl>
            </div>
            <div class="tab-panel" id="67pcg" role="tabpanel" aria-hidden="true">
              <img class="flex-img details-img" src="img/cg.jpg" alt="Photo taken by the Rosetta spacecraft">
              <dl class="details">
                <dt>Name</dt>
                <dd>67P/C-G</dd>
                <dt>Discovery year</dt>
                <dd>1969</dd>
                <dt>Discovered by</dt>
                <dd>Klim Ivanovych Churyumov, Svetlana Ivanovna Gerasimenko</dd>
              </dl>
            </div>
            <div class="tab-panel" id="jupiter" role="tabpanel" aria-hidden="true">
              <img class="flex-img details-img" src="img/jupiter.jpg" alt="Photo of Jupiter taken by New Horizons during its gravity assist">
              <dl class="details">
                <dt>Name</dt>
                <dd>Jupiter</dd>
                <dt>Discovery year</dt>
                <dd>7–8 BCE</dd>
                <dt>Discovered by</dt>
                <dd>Babylonian astronomers</dd>
              </dl>
            </div>
          </div>
        </div>
  
      </article>
    </main>
    </body>
</html>
