<!DOCTYPE html>
<html lang="en">
<head>
<title>GPX QA and Analysis</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- styles -->
<link href="scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="scripts/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" media="screen">
<link href="scripts/jqueryui/css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet" media="screen">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/buttons/1.5.1/css/buttons.dataTables.min.css" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.12/css/jquery.dataTables.css">

<!-- libraries -->
<script src="scripts/jquery-1.10.2.min.js"> </script>
<script src="scripts/opencpu-0.4.js"> </script>
<script src="scripts/bootstrap/js/bootstrap.js"> </script>
<script src="scripts/jqueryui/jquery-ui-1.10.3.custom.js"> </script>
<script src="scripts/knockout-min.js"></script>
<script src="scripts/leaflet.js"></script>
<script src="scripts/gpx.js"></script>
<script src="scripts/jquery.dataTables.min.js"></script>
<script src="scripts/dataTables.buttons.min.js"></script>
<script src="scripts/dataTables.flash.min.js"></script>
<script src="scripts/jszip.min.js"></script>
<script src="scripts/pdfmake.min.js"></script>
<script src="scripts/vfs_font.js"></script>
<script src="scripts/buttons.html5.min.js"></script>
<script src="scripts/buttons.print.min.js"></script>

<script type="text/javascript">

$(document).ready(function() {

  var viewModel = {
    session_tmp: ko.observable(),
    gpx_file_name: ko.observable(),
    leafletMap: ko.observable(),
    rDataOutput: ko.observable(),
    //gpx.js output data
    get_name: ko.observable(),//returns the name of the GPX track
    get_distance_imp: ko.observable(),//returns the total track distance in miles
    get_start_time: ko.observable(),//returns a Javascript Date object representing the starting time
    get_time_zone: ko.observable(),
    get_start_date: ko.observable(),
    get_moving_time: ko.observable(),//returns the moving time, in milliseconds
    get_total_time: ko.observable(),//returns the total track time, in milliseconds
    get_moving_pace_imp: ko.observable(),//returns the average moving pace in milliseconds per hour
    get_moving_speed_imp: ko.observable(),//returns the average moving speed in miles per hour
    get_total_speed_imp: ko.observable(),//returns the average total speed in miles per hour
    get_elevation_min_imp: ko.observable(),// returns the lowest elevation, in feet
    get_elevation_max_imp: ko.observable(),// returns the highest elevation, in feet
    get_elevation_gain_imp: ko.observable(),// returns the cumulative elevation gain, in feet
    get_elevation_loss_imp: ko.observable(),//returns the cumulative elevation loss, in feet
    //full elevation, cadence  data
    get_elevation_data_imp: ko.observable(),
    get_cadence_data_imp: ko.observable()
  };

  function clearData(){
    $('#step_2').css("opacity", 0.2);
    $('#plotdiv').css("opacity", 0.2);
    $('#gpxTable').css("opacity", 0.2);
    viewModel.leafletMap().eachLayer(function (layer) {
      // if (layer._url!='http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}'){
      if (layer.hasOwnProperty('_gpx')){
        viewModel.leafletMap().removeLayer(layer);
        viewModel.leafletMap().setView([37.8, -96], 4);
      }
    });
    viewModel.get_name(null);
    viewModel.get_distance_imp(null);
    viewModel.get_start_time(null);
    viewModel.get_time_zone(null);
    viewModel.get_start_date(null);
    viewModel.get_moving_time(null);
    viewModel.get_total_time(null);
    viewModel.get_moving_pace_imp(null);
    viewModel.get_moving_speed_imp(null);
    viewModel.get_total_speed_imp(null);
    viewModel.get_elevation_min_imp(null);
    viewModel.get_elevation_max_imp(null);
    viewModel.get_elevation_gain_imp(null);
    viewModel.get_elevation_loss_imp(null);
    viewModel.get_elevation_data_imp(null);
    viewModel.get_cadence_data_imp(null);
  }

  Object.prototype.hasOwnProperty = function(property) {
      return this[property] !== undefined;
  };

  function msToTime(duration) {
    var milliseconds = parseInt((duration%1000)/100),
    seconds = parseInt((duration/1000)%60),
    minutes = parseInt((duration/(1000*60))%60),
    hours = parseInt((duration/(1000*60*60))%24);

    hours = (hours < 10) ? "0" + hours : hours;
    minutes = (minutes < 10) ? "0" + minutes : minutes;
    seconds = (seconds < 10) ? "0" + seconds : seconds;

    return hours + ":" + minutes + ":" + seconds + "." + milliseconds;
  }

  initDT({}, false)
  //Display if dev.html or not
  var cur_url = window.location.href.split(/[\\\/]/)[window.location.href.split(/[\\\/]/).length-1]
  if(cur_url == "dev.html"){
    $("#dev_check").html(cur_url);
  }

  $("#process_data").attr("disabled", "disabled");
  $('.dt-button').attr("disabled", "disabled");
  $("#session_url").attr("disabled", "disabled");

  $('#step_2').css("opacity", 0.2);
  $('#plotdiv').css("opacity", 0.2);
  $('#gpxTable').css("opacity", 0.2);

  //initialize leaflet map
  var map = L.map('plotdiv');
    L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);
    map.setView([37.8, -96], 4);

    viewModel.leafletMap(map)

  //automatically upload GPX file on change.
  $("#gpxfile").on("change", function(){

  //verify that a file is selected
  if($("#gpxfile")[0].files[0]){
    clearData()
    $("#successdiv").empty().show();
    $("#errordiv").empty().show();

    //////////////////////////////
    //Upload and validate the data
    //////////////////////////////

  viewModel.gpx_file_name($("#gpxfile")[0].files[0].name)

    var req = ocpu.call("gpx_validation", {
        gpxfile : $("#gpxfile")[0].files[0]
    }, function(session){
        viewModel.session_tmp(session.getLoc())

        //retrieve javascript object as json
        session.getObject(function(data)  {
          viewModel.rDataOutput(data)
          $("#session_url").removeAttr("disabled");
          $("#session_url").attr("href", session.getLoc()).attr("target","_blank")
          $("#process_data").removeAttr("disabled");

          $('#step_2').css("opacity", 1);
          $('#plotdiv').css("opacity", 1);
          $('#gpxTable').css("opacity", 1);

          successmsg("GPX file successfully loaded!");
          //refresh the map

          viewModel.leafletMap().eachLayer(function (layer) {
            if (layer.hasOwnProperty('_gpx')){
              viewModel.leafletMap().removeLayer(layer);
            }
          });
          //load gpx
          var gpx_file = session.getLoc() +'files/'+ viewModel.gpx_file_name(); 
          var gpxLayer = new L.GPX(gpx_file, {async: true})

          gpxLayer.on('loaded', function(e) {
            map.fitBounds(e.target.getBounds());
            viewModel.get_name(e.target.get_name())//returns the name of the GPX track
            viewModel.get_distance_imp(e.target.get_distance_imp().toFixed(2) + ' mi')//returns the total track distance in miles
            // viewModel.get_time_zone(e.target.get_start_time().getTimezoneOffset())//returns a Javascript Date object representing the starting time
            viewModel.get_start_date(e.target.get_start_time().toDateString())//returns a Javascript Date object representing when the last point was recorded
            viewModel.get_start_time(e.target.get_start_time().toLocaleTimeString())//returns a Javascript Date object representing when the last point was recorded
            viewModel.get_moving_time(msToTime(e.target.get_moving_time()))//returns the moving time, in milliseconds
            viewModel.get_total_time(msToTime(e.target.get_total_time()))//returns the total track time, in milliseconds
            // viewModel.get_moving_pace_imp(e.target.get_moving_pace_imp())//returns the average moving pace in milliseconds per hour
            viewModel.get_moving_speed_imp(e.target.get_moving_speed_imp().toFixed(2)+' mph')//returns the average moving speed in miles per hour
            viewModel.get_total_speed_imp(e.target.get_total_speed_imp().toFixed(2) + ' mph')//returns the average total speed in miles per hour
            viewModel.get_elevation_min_imp(e.target.get_elevation_min_imp().toFixed(2) + "'")// returns the lowest elevation, in feet
            viewModel.get_elevation_max_imp(e.target.get_elevation_max_imp().toFixed(2) + "'")// returns the highest elevation, in feet
            viewModel.get_elevation_gain_imp(e.target.get_elevation_gain_imp().toFixed(2) + "'")// returns the cumulative elevation gain, in feet
            viewModel.get_elevation_loss_imp(e.target.get_elevation_loss_imp().toFixed(2) + "'")//returns the cumulative elevation loss, in feet
            //full elevation, heartrate, cadence and temperature data
            viewModel.get_elevation_data_imp(e.target.get_elevation_data_imp())
            viewModel.get_cadence_data_imp(e.target.get_cadence_data_imp())
          }).addTo(viewModel.leafletMap());

        });

      }).fail(function(jqXHR){
        clearData()
        errormsg(jqXHR.responseText);
      }).always(function(){
        var session_url = document.getElementById("session_url");
        session_url.style.cursor = "pointer";
        initDT({}, true) //clear datatable
    });
  }
});

//R output to popup
function successmsg(text){
  $("#successdiv").empty().append('<div class="alert alert-success alert-dismissable"><a href="#" class="close" data-dismiss="alert">&times;</a>' + text + '</div>');

  // setTimeout(function(){ 
  //   $("#successdiv").fadeOut( "slow", function() {
  //       // Animation complete.
  //     });
  // }, 5000 );
}

//R output to popup
function errormsg(text){
    $("#errordiv").empty().append('<div class="alert alert-danger alert-dismissable"><a href="#" class="close" data-dismiss="alert">&times;</a>' + text + '</div>');

  //   setTimeout(function(){ 
  //     $("#errordiv").fadeOut( "slow", function() {
  //        // Animation complete.
  //     });
  // }, 5000 );
}

function initDT(data , update){

  if(update){
    var datatable = $('#gpxDataTable').DataTable();
      datatable.clear();
      datatable.rows.add(data);
      datatable.draw();

  }else{
    $('#gpxDataTable').dataTable({
      dom: 'Bfrtip',
      data: data,
      searching: false,
      pageLength: 5,
      columns: [
        {"data": "DateTime", title: "DateTime"},
        {"data":  "Dist", title: "Dist"},
        // {"data":  "Dist2D", title: "Dist2D"},
        // {"data":  "East", title: "East"},
        {"data":  "Elevation", title: "Elevation"},
        {"data":  "Gradient", title: "Gradient"},
        {"data":  "Latitude", title: "Latitude"},
        {"data":  "Longitude", title: "Longitude"},
        // {"data":  "North", title: "North"},
        {"data":  "Pace", title: "Pace"},
        {"data":  "Seconds", title: "Seconds"},
        {"data":  "Speed", title: "Speed"},
        {"data":  "dDist", title: "dDist"},
        // {"data":  "dDist2D", title: "dDist2D"},
        // {"data":  "dEast", title: "dEast"},
        // {"data":  "dNorth", title: "dNorth"},
        // {"data":  "dUp", title: "dUp"}
        ],
      buttons: [
          {
            extend: 'collection',
            text: 'Export',
            buttons: [ 'pdfHtml5', 'csvHtml5', 'copyHtml5', 'excelHtml5' ]
          }
        ]
      });
    }
}

  //////////////////////////////
  //Process Data Table
  //////////////////////////////
  $(function(){
    $("#process_data").on("click", function(){
      $(".dt-button").removeAttr("disabled");
      $("#process_data").attr("disabled", "disabled");
        initDT(viewModel.rDataOutput(), true)
    });
  });

  //////////////////////////////
  //Ajax spinLoad Bar
  //////////////////////////////

  $(document).ajaxStart(function() {
    $(".spinLoad").show();
  });

  $(document).ajaxStop(function() {
    $(".spinLoad").hide();
  });

  ko.applyBindings(viewModel)

});

</script>

<link href="styles/bootstrap_three_panel.css" rel="stylesheet" type="text/css">

</head>

  <body>
    <div class="flex-container">
      <!-- First Panel -->
      <div class="flex-item well" id="user_input_panel">
        <!-- Display session info -->
        <div id='env_wrapper'>
          <a id="session_url">Session URL</a>
          <div id="dev_check"></div>
        </div>
        <!-- Title Div -->
        <div id="project_title">
          GPX QA v1.3
        </div>
         <!-- Credits Div -->
        <div id="credits">
          by <a href="http://www.azimuth1.com">Robert Sellers/Azimuth1</a>
        </div>
        <!-- Step 1: Load File -->
        <form enctype="multipart/form-data" id="uploadform" name="uploadform" role="form">
          <fieldset id="step_1">
            <legend>Load GPX data</legend>
            <div class="form-group">
              <div class="loadFileContainer" style="margin-bottom: 15px;">
              <input id="gpxfile" type="file" style="float:left; display: inline-block;">
              <img src="./img/h6viz.gif" alt="spinner" class="spinLoad" style="width:22px;height:22px;float:left; display: none; vertical-align: top;">
            </div>
            </div>
          </fieldset>
          <div id='step_2'>
            <div class='gpx_metadata'>
              <legend>Preview Metadata</legend>
              <b>File name:</b> <span data-bind="text: get_name"></span><br>
              <b>Start date:</b> <span data-bind="text: get_start_date"></span><br>
              <b>Start time:</b> <span data-bind="text: get_start_time"></span><br>
              <b>Distance:</b> <span data-bind="text: get_distance_imp"></span><br>
              <!-- <b>Time Zone:</b> <span data-bind="text: get_time_zone"></span><br> -->
              <!-- <b>End Time:</b> <span data-bind="text: get_end_time"></span><br> -->
              <b>Moving Time:</b> <span data-bind="text: get_moving_time"></span><br>
              <b>Total Time:</b> <span data-bind="text: get_total_time"></span><br>
              <!-- <b>Moving Pace:</b> <span data-bind="text: get_moving_pace_imp"></span><br> -->
              <b>Moving Speed:</b> <span data-bind="text: get_moving_speed_imp"></span><br>
              <b>Total Speed:</b> <span data-bind="text: get_total_speed_imp"></span><br>
              <b>Elevation (min):</b> <span data-bind="text: get_elevation_min_imp"></span><br>
              <b>Elevation (max):</b> <span data-bind="text: get_elevation_max_imp"></span><br>
              <b>Elevation gain:</b> <span data-bind="text: get_elevation_gain_imp"></span><br>
              <b>Elevation loss:</b> <span data-bind="text: get_elevation_loss_imp"></span><br>
            </div>
            <!-- Step 2: Display Data -->
            <fieldset>
              <legend>Load DataTable</legend>
              <div class="form-group">
                <button disabled="disabled" id="process_data" type="button">Load table</button><br>
              </div>
            </fieldset>
          </div>
        </form>
        <!-- R Relayed Message and spinLoad Information -->
        <div id="warning">
          <div id="successdiv"></div>
          <div id="errordiv"></div>
        </div>
      </div>
      <div class="flex-item well" id="plotdiv"></div>
      <div class="flex-item well" id="gpxTable">
          <table id="gpxDataTable" class="display" cellspacing="0">
          </table>
      </div>
    </div>
  </body>
</html>
