<!DOCTYPE html>
<html lang="en">
<head>
<title>GPX - QA and Analysis</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- Primary Stylesheet -->
<link href="main.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">

<!-- Stand-alone Libraries -->
<script src="components/jquery-1.10.2.min.js"></script>
<script src="components/jqueryui/jquery-ui-1.10.3.custom.js"></script>
<script src="components/opencpu-0.4.js"></script>
<script src="components/knockout-min.js"></script>
<script src="components/moment.min.js"></script>
<script src="components/vfs_font.js"></script>

<!-- Jquery Datatables -->
<script src="components/jquery_datatables/jquery.dataTables.min.js"></script>
<script src="components/jquery_datatables/modules/dataTables.buttons.min.js"></script>
<script src="components/jquery_datatables/modules/dataTables.flash.min.js"></script>
<script src="components/jquery_datatables/modules/pdfmake.min.js"></script>
<script src="components/jquery_datatables/modules/buttons.html5.min.js"></script>
<script src="components/jquery_datatables/modules/buttons.print.min.js"></script>
<link href="components/jquery_datatables/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="components/jquery_datatables/css/buttons.dataTables.min.css" rel="stylesheet"/>

<!-- Highcharts -->
<script src="components/highcharts/highcharts.js"></script>
<script src="components/highcharts/modules/series-label.js"></script>
<script src="components/highcharts/modules/exporting.js"></script>
<script src="components/highcharts/modules/export-data.js"></script>

<!-- Leaflet -->
<script src="components/leaflet/leaflet.js"></script>
<script src="components/leaflet/modules/gpx.js"></script>
<link href="components/leaflet/css/leaflet.css" rel="stylesheet"/>

<script type="text/javascript">

$(document).ready(function() {

  var vm = {
    session_tmp: ko.observable(),
    gpx_file_name: ko.observable(),
    leafletMap: ko.observable(),
    rDataOutput: ko.observable(),
    //gpx.js output data
    gpxjs_vars: ko.observable({
      get_name: null,//returns the name of the GPX track
      get_distance_imp: null,//returns the total track distance in miles
      get_start_time: null,//returns a Javascript Date object representing the starting time
      get_time_zone: null,
      get_start_date: null,
      get_moving_time: null,//returns the moving time, in milliseconds
      get_total_time: null,//returns the total track time, in milliseconds
      get_moving_pace_imp: null,//returns the average moving pace in milliseconds per hour
      get_moving_speed_imp: null,
      get_total_speed_imp: null,//returns the average total speed in miles per hour
      get_elevation_min_imp: null,// returns the lowest elevation, in feet
      get_elevation_max_imp: null,// returns the highest elevation, in feet
      get_elevation_gain_imp: null,// returns the cumulative eleva`tion gain, in feet
      get_elevation_loss_imp: null,//returns the cumulative elevation loss, in feet
      //full elevation, cadence  data
      get_elevation_data_imp: null,
      get_cadence_data_imp: null
    }),
    elevationArray: ko.observableArray(null),
    secondsArray: ko.observableArray(null),
    speedArray: ko.observableArray(null),
    paceArray: ko.observableArray(null)
  };

//   vm.elevation_v_seconds = ko.computed(function(){
//     return vm.secondsArray().map(function(v,i) {
//         return [v._i, vm.elevationArray()[i]];
//     });
//   })

//   vm.speed_v_seconds = ko.computed(function(){
//     return vm.secondsArray().map(function(v,i) {
//         return [v._i, vm.paceArray[i]];
//     });
//   })

  vm.highcharts_series = ko.computed(function(){
      var series1 = vm.secondsArray().map(function(v,i) {
            return [v._i, vm.elevationArray()[i]];
        });
      var series2 = vm.secondsArray().map(function(v,i) {
            return [v._i, vm.paceArray[i]];
        });
        return [series1, series2]
  })

  vm.highcharts_series.subscribe(function(){
    vm.highchart().series[0].setData(vm.elevation_v_seconds(),false)
    // vm.highchart().series[1].setData(vm.speed_v_seconds(),false)
    vm.highchart().redraw();
  })

//   vm.elevation_v_seconds.subscribe(function(){
//     // vm.highchart().series[0].setData(vm.elevation_v_seconds(),false)
//     vm.highchart().series[1].setData(vm.speed_v_seconds(),false)
//     vm.highchart().redraw();
//   })

  vm.highchart= ko.computed(function(){
      return new Highcharts.chart('container', {
        chart: {zoomType: 'xy'},
        title: {text: 'Track Data Visualization'},
        subtitle: {text: '',style: {display: 'none'}},
        xAxis: {
          type: 'datetime',
          crosshair: true,
          title: {text: 'Hours'}}, 
        yAxis: {title: {text: ''}, min: 0},
        legend: {layout: 'vertical', align: 'right',verticalAlign: 'middle' },
            chart: {type: 'spline' },
        tooltip: {
            headerFormat: '<b>{series.name}</b><br>',
            pointFormat: '{point.x:%e. %b}: {point.y:.2f} m'},
        plotOptions: {series: {label: {connectorAllowed: false}}},
        series: [
          {name: "Elevation",data: vm.elevation_v_seconds()},
          { name: "Speed",data: vm.speed_v_seconds()}],
        responsive: {
            rules: [{
                condition: {maxWidth: 500},
                chartOptions: {
                    legend: {layout: 'horizontal',align: 'center',verticalAlign: 'bottom'
            }}}]}
        });
    });

  vm.highchart()

  /* ----- Navigation ----- */

  $('.nav').find('a').attr('tabindex', -1);

  $('.nav-btn').on('click', function () {
    if ($('.nav-wrap').hasClass('is-open')) {
      $('.nav-wrap').removeClass('is-open');
      $('.nav').attr('aria-hidden', true);
      $('.nav-btn').attr('aria-expanded', false);
      $('.nav').find('a').attr('tabindex', -1);
    } else {
      $('.nav-wrap').addClass('is-open');
      $('.nav-wrap').addClass('is-fixed');
      $('.nav-btn').addClass('is-active');
      $('.nav').attr('aria-hidden', false);
      $('.nav-btn').attr('aria-expanded', true);
      $('.nav').find('a').attr('tabindex', 0);
    }
  });

  $('.nav-wrap').on('transitionend', function () {
    if (!$('.nav-wrap').hasClass('is-open')) {
      $('.nav-wrap').removeClass('is-fixed');
      $('.nav-btn').removeClass('is-active');
    }
  });

  $('.nav-wrap').on('keypress', function (e) {
    switch (e.keyCode) {
      case 27:
        $('.nav-wrap').removeClass('is-open');
        $('.nav').attr('aria-hidden', true);
        $('.nav-btn').attr('aria-expanded', false);
        $('.nav').find('a').attr('tabindex', -1);
        $('.nav-btn').focus();
        break;
    }
  });

  /* ----- Tabs ----- */

  var $tabs = $('.tabs');
  var $panels = $('.tab-panel');

  $tabs.on('click', 'a', function (e) {
    e.preventDefault();

    var id = $(this).attr('href');

    $panels.filter('[aria-hidden="false"]').attr('aria-hidden', true);
    $tabs.find('[aria-selected="true"]').attr('aria-selected', false);

    $(this).attr('aria-selected', true);
    $(id).attr('aria-hidden', false);
  });

  //////////////////////////////
  //Ajax spinLoad Bar
  //////////////////////////////

  $(document).ajaxStart(function() {
    $(".spinLoad").show();
  });

  $(document).ajaxStop(function() {
    $(".spinLoad").hide();
  });


  //R output to popup
  function successmsg(text){
    $("#successdiv").empty().append('<div class="alert alert-success alert-dismissable">' + text + '</div>');

  }

  //R output to popup
  function errormsg(text){
      $("#errordiv").empty().append('<div class="alert alert-danger alert-dismissable">' + text + '</div>');
  }


  function clearData(){
    $('#step_2').css("opacity", 0.2);
    $('#plotdiv').css("opacity", 0.2);
    $('#gpxTable').css("opacity", 0.2);
    $(".dt-button").css("disabled", true);
    vm.leafletMap().eachLayer(function (layer) {
      if (layer.hasOwnProperty('_gpx')){
        vm.leafletMap().removeLayer(layer);
        vm.leafletMap().setView([37.8, -96], 4);
      }
    });
    map_lock('lock')
  }

  Object.prototype.hasOwnProperty = function(property) {
      return this[property] !== undefined;
  };

  function map_lock(toggle){
    if (toggle=='unlock'){
      vm.leafletMap().dragging.enable();
      vm.leafletMap().touchZoom.enable();
      vm.leafletMap().doubleClickZoom.enable();
      vm.leafletMap().scrollWheelZoom.enable();
      vm.leafletMap().boxZoom.enable();
      vm.leafletMap().keyboard.enable();
      if (vm.leafletMap().tap) vm.leafletMap().tap.enable();
      document.getElementById('plotdiv').style.cursor='grab';
    }if (toggle=='lock'){
      vm.leafletMap().dragging.disable();
      vm.leafletMap().touchZoom.disable();
      vm.leafletMap().doubleClickZoom.disable();
      vm.leafletMap().scrollWheelZoom.disable();
      vm.leafletMap().boxZoom.disable();
      vm.leafletMap().keyboard.disable();
      if (vm.leafletMap().tap) vm.leafletMap().tap.disable();
      document.getElementById('plotdiv').style.cursor='default';
    }
  }

  function msToTime(duration) {
    var milliseconds = parseInt((duration%1000)/100),
    seconds = parseInt((duration/1000)%60),
    minutes = parseInt((duration/(1000*60))%60),
    hours = parseInt((duration/(1000*60*60))%24);
    hours = (hours < 10) ? "0" + hours : hours;
    minutes = (minutes < 10) ? "0" + minutes : minutes;
    seconds = (seconds < 10) ? "0" + seconds : seconds;
    return hours + ":" + minutes + ":" + seconds + "." + milliseconds;
  }

  initDT({}, false)
  // $("#process_data").attr("disabled", "disabled");
  $('.dt-button').attr("disabled", "disabled");
  $("#session_url").attr("disabled", "disabled");
  $('#step_2').css("opacity", 0.2);
  $('#plotdiv').css("opacity", 0.2);
  $('#gpxTable').css("opacity", 0.2);

  //initialize leaflet map
  var map = L.map('plotdiv');
    L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);
    map.setView([37.8, -96], 4);

  vm.leafletMap(map);
  map_lock('lock');

  //automatically upload GPX file on change.
  $("#gpxfile").on("change", function(){

  //verify that a file is selected
  if($("#gpxfile")[0].files[0]){
    clearData();
    $("#successdiv").empty().show();
    $("#errordiv").empty().show();

    //////////////////////////////
    //Upload and validate the data
    //////////////////////////////

  vm.gpx_file_name($("#gpxfile")[0].files[0].name)

    var req = ocpu.call("gpx_validation", {
        gpxfile : $("#gpxfile")[0].files[0]
    }, function(session){
        vm.session_tmp(session.getLoc());

        //retrieve javascript object as json
        session.getObject(function(data)  {
          vm.rDataOutput(data)
          $("#session_url").removeAttr("disabled");
          $("#session_url").attr("href", session.getLoc()).attr("target","_blank");
          $('#step_2').css("opacity", 1);
          $('#plotdiv').css("opacity", 1);

          successmsg("GPX file successfully loaded!");

          //////////////////////////////////
          //Update Data Table
          $('#gpxTable').css("opacity", 1);
          $(".dt-button").removeAttr("disabled");
          initDT(vm.rDataOutput(), true);

          //////////////////////////////////
          //Update Leaflet
          vm.leafletMap().eachLayer(function (layer) {
            if (layer.hasOwnProperty('_gpx')){
              vm.leafletMap().removeLayer(layer);
            }
          });
          //load gpx
          var gpx_file = session.getLoc() +'files/'+ vm.gpx_file_name(); 
          var gpxLayer = new L.GPX(gpx_file, {async: true})

          gpxLayer.on('loaded', function(e) {
            map.fitBounds(e.target.getBounds());
            t = e.target;
            vm.gpxjs_vars({
              get_name: t.get_name(),//returns the name of the GPX track
              get_distance_imp: t.get_distance_imp().toFixed(2) + ' mi',//returns the total track distance in miles
              get_start_time: t.get_start_time().toLocaleTimeString(),//returns a Javascript Date object representing the starting time
              get_start_date: t.get_start_time().toDateString(),
              get_moving_time: msToTime(t.get_moving_time()),//returns the moving time, in milliseconds
              get_total_time: msToTime(t.get_total_time()),//returns the total track time, in milliseconds
              get_moving_pace_imp: t.get_moving_pace_imp(),//returns the average moving pace in milliseconds per hour
              get_moving_speed_imp: t.get_moving_speed_imp().toFixed(2)+' mph',
              get_total_speed_imp: t.get_total_speed_imp().toFixed(2) + ' mph',//returns the average total speed in miles per hour
              get_elevation_min_imp: t.get_elevation_min_imp().toFixed(2) + "'",// returns the lowest elevation, in feet
              get_elevation_max_imp: t.get_elevation_max_imp().toFixed(2) + "'",// returns the highest elevation, in feet
              get_elevation_gain_imp: t.get_elevation_gain_imp().toFixed(2) + "'",// returns the cumulative elevation gain, in feet
              get_elevation_loss_imp: t.get_elevation_loss_imp().toFixed(2) + "'",//returns the cumulative elevation loss, in feet
              //full elevation, cadence  data
              get_elevation_data_imp: t.get_elevation_data_imp(),
              get_cadence_data_imp: t.get_cadence_data_imp()
            });
          }).addTo(vm.leafletMap());
          map_lock('unlock');

          //////////////////////////////////
          //Update Highcharts
          vm.secondsArray(vm.rDataOutput().map(a => a.Seconds));
          vm.elevationArray(vm.rDataOutput().map(a => a.Elevation));
          vm.paceArray(vm.rDataOutput().map(a => a.Pace));

        });
      }).fail(function(jqXHR){
        clearData();
        errormsg(jqXHR.responseText);
      }).always(function(){
        var session_url = document.getElementById("session_url");
        session_url.style.cursor = "pointer";
    });
  }
});

function initDT(data , update){

  if(update){
    var datatable = $('#gpxDataTable').DataTable();
    datatable.clear();
    datatable.rows.add(data);
    datatable.draw();

  }else{
    $('#gpxDataTable').dataTable({
      data: data,
      dom: 'Bfrtip',
      searching: false,
      responsive: true,
      "bAutoWidth": false,
      pageLength: 5,
      "aoColumns" : [
            {"data": "DateTime", title: "DateTime"},
            {"data":  "Dist", title: "Dist"},
            {"data":  "Elevation", title: "Elev"},
            {"data":  "Gradient", title: "Grad"},
            {"data":  "Latitude", title: "Lat"},
            {"data":  "Longitude", title: "Lon"},
            {"data":  "Pace", title: "Pace"},
            {"data":  "Seconds", title: "Seconds"},
            {"data":  "Speed", title: "Speed"}
        ],
      buttons: [
          {
            extend: 'collection',
            text: 'Export',
            buttons: [ 'pdfHtml5', 'csvHtml5', 'copyHtml5', 'excelHtml5' ]
          }
        ]
      });
    }
}

  ko.applyBindings(vm);

});

</script>

</head>

  <body>
    <header class="masthead" role="banner">
      <strong class="logo">
        <!-- Add logo to this -->
        <img class="logo-img logo-img-small" src="img/logo-small.svg" alt="GPX File Analyzer">
        <img class="logo-img logo-img-big" src="img/logo-small.svg" alt="GPX File Analyzer">
      </strong>
      <h1 class="title">Menu</h1>
      <nav class="nav-wrap" role="navigation">

        <button class="nav-btn" aria-controls="nav" aria-expanded="false"><i class="nav-icon">Toggle Navigation</i></button>
        <ul class="nav" id="nav" aria-hidden="true">
          <li><span class="nav-label"><span class="nav-label-back">GPS</span></span>
            <ol><li><a href="http://robertsellers.ocpu.io/gpxanalysis/www/">GPX Analyzer</a></li></ol>
          </li>
          <li><span class="nav-label"><span class="nav-label-back">MIP</span></span>
            <ol><li><a href="http://azimuth1.ocpu.io/mihptcheck/www/">MIHPT</a></li></ol>
          </li>
          <li><span class="nav-label"><span class="nav-label-back">pointCollect</span></span>
            <ol><li><a href="https://github.com/Azimuth1/pointCollect">pointCollect</a></li></ol>
          </li>
          <li><span class="nav-label"><span class="nav-label-back">Session URL</span></span>
            <ol><li><a id="session_url">View Session</a></li></ol>
          </li>
          <li><span class="nav-label"><span class="nav-label-back">Credits</span></span>
              <ol><li>by <a href="http://www.azimuth1.com">Azimuth1</a></li></ol>
            </li>
        </ul>
      </nav>
    </header>
  
    <main role="main">

      <article class="panel">
        <h2 class="panel-head section-label" tabindex="0"><span class="section-label-back">Input</span></h2>
          <!-- Step 1: Load File -->
            <form enctype="multipart/form-data" id="uploadform" name="uploadform" role="form">
            <fieldset id="step_1">
              <legend>Load GPX data</legend>
              <div class="form-group">
                <div class="loadFileContainer">
                <input id="gpxfile" type="file" style="display: inline-block;">
                <img src="./img/h6viz.gif" alt="spinner" class="spinLoad" style="width:22px;height:22px;float:right; display: none; vertical-align: top;">
              </div>
              </div>
            </fieldset>
            <!-- R Relayed Message and spinLoad Information -->
            <fieldset id="warnings_panel">
                <legend>Warnings</legend>
                <div id="successdiv"></div>
                <div id="errordiv"></div>
            </fieldset>
          </td></table>
          </form>

          <article class="panel" style="width:100%;">
      
            <div class="tab-group">
              <ul class="tabs clearfix" role="tablist">
                <li class="tab" role="presentation"><a href="#metadata" role="tab" aria-controls="metadata" aria-selected="true">Metadata</a></li>
                <li class="tab" role="presentation"><a href="#highcharts" role="tab" aria-controls="highcharts">Profile</a></li>
              </ul>
      
              <div class="tab-panels">
                  <div class="tab-panel" id="metadata" role="tabpanel" aria-hidden="false">
                      <div class='gpx_metadata'>
                        <b>Start date:</b> <span data-bind="text: gpxjs_vars().get_start_date"></span><br>
                        <b>Start time:</b> <span data-bind="text: gpxjs_vars().get_start_time"></span><br>
                        <b>Distance:</b> <span data-bind="text: gpxjs_vars().get_distance_imp"></span><br>
                        <b>Moving Time:</b> <span data-bind="text: gpxjs_vars().get_moving_time"></span><br>
                        <b>Total Time:</b> <span data-bind="text: gpxjs_vars().get_total_time"></span><br>
                        <b>Moving Speed:</b> <span data-bind="text: gpxjs_vars().get_moving_speed_imp"></span><br>
                        <b>Total Speed:</b> <span data-bind="text: gpxjs_vars().get_total_speed_imp"></span><br>
                        <b>Elevation (min):</b> <span data-bind="text: gpxjs_vars().get_elevation_min_imp"></span><br>
                        <b>Elevation (max):</b> <span data-bind="text: gpxjs_vars().get_elevation_max_imp"></span><br>
                        <b>Elevation gain:</b> <span data-bind="text: gpxjs_vars().get_elevation_gain_imp"></span><br>
                        <b>Elevation loss:</b> <span data-bind="text: gpxjs_vars().get_elevation_loss_imp"></span><br>
                      </div>
                    </div>
                <div class="tab-panel" id="highcharts" role="tabpanel" aria-hidden="true">
                    <div id="container"></div>
                </div>
              </div>
            </div>
      
          </article>
      </article>
    
      <article class="panel">
        <h2 class="panel-head section-label" tabindex="0"><span class="section-label-back">GPX Track Map</span></h2>
        <div id="plotdiv" style="height:450px;"></div>
      </article>
  
      <article class="panel" style="width:100%;">
        <h2 class="panel-head section-label" tabindex="0"><span class="section-label-back">Data Table</span></h2>
        <div id="gpxTable" style="background:#6c8fe0" >
          <table id="gpxDataTable" class="display" cellspacing="0" width="100%">
          </table>
      </div>
      </article>
    </main>
    </body>
</html>
