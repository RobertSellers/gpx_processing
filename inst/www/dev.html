<!DOCTYPE html>
<html lang="en">
<head>
<title>GPX - QA and Analysis</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- Primary Stylesheet -->
<link href="main.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">

<!-- Stand-alone Libraries -->
<script src="components/jquery-1.10.2.min.js"></script> <!--Must be First -->
<script src="components/opencpu-0.4.js"></script> <!--Second -->
<script src="components/jqueryui/jquery-ui-1.10.3.custom.js"></script> <!--Third -->
<script src="components/knockout-min.js"></script>
<script src="components/moment.min.js"></script>
<script src="components/vfs_font.js"></script>

<!-- Highcharts -->
<script src="components/highcharts/highcharts.js"></script>
<script src="components/highcharts/modules/series-label.js"></script>
<script src="components/highcharts/modules/exporting.js"></script>
<script src="components/highcharts/modules/export-data.js"></script>

<!-- Leaflet -->
<script src="components/leaflet/leaflet.js"></script>
<script src="components/leaflet/modules/gpx.js"></script>
<link href="components/leaflet/css/leaflet.css" rel="stylesheet"/>

<!-- Custom Scripts -->
<script src="js/utilities.js"></script>
<script src="js/CSVExport.js"></script>

<style type="text/css">
    body { width: 800px; margin: 0 auto; }
    .gpx { border: 2px #aaa solid; border-radius: 5px;
      box-shadow: 0 0 3px 3px #ccc;
      width: 800px; margin: 1em auto; }
    .gpx header { padding: 0.5em; }
    .gpx h3 { margin: 0; padding: 0; font-weight: bold; }
    .gpx .start { font-size: smaller; color: #444; }
    .gpx .map { border: 1px #888 solid; border-left: none; border-right: none;
      width: 800px; height: 500px; margin: 0; }
    .gpx footer { background: #f0f0f0; padding: 0.5em; }
    .gpx ul.info { list-style: none; margin: 0; padding: 0; font-size: smaller; }
    .gpx ul.info li { color: #666; padding: 2px; display: inline; }
    .gpx ul.info li span { color: black; }
</style>

<script type="text/javascript">

$(document).ready(function() {

    var vm = {
        session_tmp: ko.observable(),
        gpx_file_name: ko.observable(),
        leafletMap: ko.observable(),
        leafletControl: ko.observable(),
        rDataOutput: ko.observable(),
        //gpx.js output data
        gpxjs_vars: ko.observable({
            get_name: 'Loading...',//returns the name of the GPX track
            pace: null,
            get_distance_imp: null,//returns the total track distance in miles
            get_start_time: null,//returns a Javascript Date object representing the starting time
            get_time_zone: null,
            get_start_date: null,
            get_moving_time: null,//returns the moving time, in milliseconds
            get_total_time: null,//returns the total track time, in milliseconds
            get_moving_pace_imp: null,//returns the average moving pace in milliseconds per hour
            get_moving_speed_imp: null,
            get_total_speed_imp: null,//returns the average total speed in miles per hour
            get_elevation_min_imp: null,// returns the lowest elevation, in feet
            get_elevation_max_imp: null,// returns the highest elevation, in feet
            get_elevation_gain_imp: null,// returns the cumulative eleva`tion gain, in feet
            get_elevation_loss_imp: null,//returns the cumulative elevation loss, in feet
            elevation_net: null,
            //full elevation, cadence  data
            get_elevation_data_imp: null,
            get_cadence_data_imp: null
        }),
        downloadCSV : function() {
            var data = this.rDataOutput();
            var filename = this.gpx_file_name().slice(0, -4);
            var exportData = new CSVExport(data, filename);
            return exportData
        }
    };

    vm.rDataOutput.subscribe(function(){
        //Update Highchart
        var timeRange = vm.rDataOutput().map(a => a.Seconds)
        //ELEVATION
        var elevationArray = vm.rDataOutput().map(a => a.Elevation)
        var timeElevation = timeRange.map(function(v,i) {
            return [v, elevationArray[i]];
        });
        //SPEED
        var speedArray = vm.rDataOutput().map(a => a.speedMPH) //CONFIRM!
        var timeSpeed = timeRange.map(function(v,i) {
            return [v, speedArray[i]];
        });
        //DATES
        var datetimeArray = vm.rDataOutput().map(a => a.DateTime)
        var timeDateTime = timeRange.map(function(v,i) {
            return [v, datetimeArray[i]];
        });
        //PACE
        var paceArray = vm.rDataOutput().map(a => a.Pace)
        var timePace = timeRange.map(function(v,i) {
            return [v, paceArray[i]];
        });
        //DISTANCE
        var distanceArray = vm.rDataOutput().map(a => a.Dist)
        var timeDist = timeRange.map(function(v,i) {
            return [v, distanceArray[i]];
        });
        //LAT LONG
        var latArray = vm.rDataOutput().map(a => a.Latitude)
        var lonArray = vm.rDataOutput().map(a => a.Longitude)
        var timeLatLon = timeRange.map(function(v,i) {
            var val = lonArray[i]+","+latArray[i]
            return [v, val];
        });
        vm.highchart().series[0].setData(timeElevation,false)
        vm.highchart().series[1].setData(timeSpeed,false)
        // vm.highchart().series[2].setData(timeDateTime,false)
        vm.highchart().series[2].setData(timePace,false)
        vm.highchart().series[3].setData(timeDist,false)
        // vm.highchart().series[5].setData(timeLatLon,false)
        vm.highchart().redraw();
    })

    vm.highchart= ko.computed(function(){

        var elevationColor = "#76a912"
        var speedColor = "#000000"

        return new Highcharts.chart('container', {
        chart: {
            zoomType: 'x',
			polar: false
        },
        title: {
        	text: 'Visualize GPX'
        },
        subtitle: {
        	text: '',
        	style: {
        		display: 'none'
        	}
        },
        xAxis: {
            labels: {
            tickInterval: 900,
            formatter: function () {
                // var days = Math.floor(this.value / (3600*24));
                var hrs   = Math.floor(this.value / 3600);
                var mnts = Math.floor(this.value / 60);
                if (this.value===0) {
                    return 0
                }else{
                    var fifteens = (Math.round(mnts/15) * 15) % 60
                    if (fifteens==0){
                        return hrs + ":00"
                    }else{
                        return hrs + ":" + ((Math.round(mnts/15) * 15) % 60);
                    }
                }}
            },
        	crosshair: true,
        	title: {
        		text: 'Duration (hh:mm)'
        	}
        },
        yAxis: [{ // Primary yAxis
            gridLineWidth: 0,
        	title: {
        		text: 'Speed (mph)',
        		style: {
        			color: speedColor
        		}
        	},
        	labels: {
        		format: '{value}',
        		style: {
        			color: speedColor
        		}
        	},
        	opposite: true
        }, { // Secondary yAxis
            labels: {
        		format: "{value}'",
        		style: {
        			color: elevationColor
        		}
        	},
        	title: {
        		text: 'Elevation in feet',
        		style: {
        			color: elevationColor
        		}
        	}
        }],
        tooltip: {
            shared: true,
            formatter: function () {
                //do nothing
            }
        },
        plotOptions: {
        	series: {
        		label: {
        			connectorAllowed: false
                },
                cursor: "pointer",
                events: {
                    click: function(event) {
                        //do nothing
                    }
                }
            },
        },
        series: [
        {
            name: "Elevation",
            color: elevationColor,
        	yAxis: 1,
        	data: [null, null],
        	type: "areaspline",
        	tooltip: {
        		valueSuffix: "'"
        	}
            }, {
                name: "Speed",
                color: speedColor,
                data: [null, null],
                type: "spline",
                // dashStyle: 'shortdot',
                tooltip: {
                    valueSuffix: ' mph'
                }
            },
            {
                name: 'timePace',
                data: [null, null],
                visible: false
            },
            {
                name: 'timeDist',
                data: [null, null],
                visible: false
            }
        ],
        credits: {
        	enabled: false
        },
        legend: {
        	enabled: false
        },
        responsive: {
        	rules: [{
        		condition: {
        			maxWidth: 500
        		}
        	}]
        }
        });
    });


    /* ----- Navigation ----- */

    $('.nav').find('a').attr('tabindex', -1);

    $('.nav-btn').on('click', function () {
        if ($('.nav-wrap').hasClass('is-open')) {
        $('.nav-wrap').removeClass('is-open');
        $('.nav').attr('aria-hidden', true);
        $('.nav-btn').attr('aria-expanded', false);
        $('.nav').find('a').attr('tabindex', -1);
        } else {
        $('.nav-wrap').addClass('is-open');
        $('.nav-wrap').addClass('is-fixed');
        $('.nav-btn').addClass('is-active');
        $('.nav').attr('aria-hidden', false);
        $('.nav-btn').attr('aria-expanded', true);
        $('.nav').find('a').attr('tabindex', 0);
        }
    });

    $('.nav-wrap').on('transitionend', function () {
        if (!$('.nav-wrap').hasClass('is-open')) {
        $('.nav-wrap').removeClass('is-fixed');
        $('.nav-btn').removeClass('is-active');
        }
    });

    $('.nav-wrap').on('keypress', function (e) {
        switch (e.keyCode) {
        case 27:
            $('.nav-wrap').removeClass('is-open');
            $('.nav').attr('aria-hidden', true);
            $('.nav-btn').attr('aria-expanded', false);
            $('.nav').find('a').attr('tabindex', -1);
            $('.nav-btn').focus();
            break;
        }
    });

    /* ----- Tabs ----- */

    var $tabs = $('.tabs');
    var $panels = $('.tab-panel');

    $tabs.on('click', 'a', function (e) {
        e.preventDefault();

        var id = $(this).attr('href');

        $panels.filter('[aria-hidden="false"]').attr('aria-hidden', true);
        $tabs.find('[aria-selected="true"]').attr('aria-selected', false);

        $(this).attr('aria-selected', true);
        $(id).attr('aria-hidden', false);
    });

    //////////////////////////////
    //Ajax spinLoad Bar
    //////////////////////////////

    $(document).ajaxStart(function() {
        $(".spinLoad").show();
    });

    $(document).ajaxStop(function() {
        $(".spinLoad").hide();
    });

    //R output to popup
    function successmsg(text){
        $("#successdiv").empty().append('<div class="alert alert-success alert-dismissable">' + text + '</div>');
    }

    //R output to popup
    function errormsg(text){
        $("#errordiv").empty().append('<div class="alert alert-danger alert-dismissable">' + text + '</div>');
    }

    function clearData(){
        $('#plotdiv').css("opacity", 0.2);
        $('#highcharts').css("opacity", 0.2);
        $(".download").attr("disabled", false);
        $(".download").css("opacity", 0.2);
        vm.highchart().series[0].setData([null,null],false)
        vm.highchart().series[1].setData([null,null],false)
        vm.highchart().redraw();
        vm.leafletMap().eachLayer(function (layer) {
            if (layer.hasOwnProperty('_gpx')){
                vm.leafletMap().removeLayer(layer);
                vm.leafletMap().setView([37.8, -96], 4);
            }
        });
        map_lock('lock')
    }

    function map_lock(toggle){
        if (toggle=='unlock'){
            // vm.leafletMap().L.Map('map', { zoomControl:false });
            vm.leafletMap().dragging.enable();
            vm.leafletMap().zoomControl.disable();
            vm.leafletMap().touchZoom.enable();
            vm.leafletMap().doubleClickZoom.enable();
            vm.leafletMap().scrollWheelZoom.enable();
            vm.leafletMap().boxZoom.enable();
            vm.leafletMap().keyboard.enable();
        if (vm.leafletMap().tap) vm.leafletMap().tap.enable();
            document.getElementById('plotdiv').style.cursor='grab';
        }if (toggle=='lock'){
            vm.leafletMap().dragging.disable();
            vm.leafletMap().zoomControl.enable();
            vm.leafletMap().touchZoom.disable();
            vm.leafletMap().doubleClickZoom.disable();
            vm.leafletMap().scrollWheelZoom.disable();
            vm.leafletMap().boxZoom.disable();
            vm.leafletMap().keyboard.disable();
        if (vm.leafletMap().tap) vm.leafletMap().tap.disable();
            document.getElementById('plotdiv').style.cursor='default';
        }
    }

    function initLeaflet(){

        var map = L.map('plotdiv', {
            zoom: 3,
                center: new L.latLng([37.8, -96]),
                layers: L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}'),
                layers: [
                L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                })
                ]
            });
        var control = L.control.layers(null, null).addTo(map);
        vm.leafletControl(control)
        vm.leafletMap(map);
    }

    function updateLeaflet(){
        //////////////////////////////////
        //Update Leaflet
        vm.leafletMap().eachLayer(function (layer) {
            if (layer.hasOwnProperty('_gpx')){
            vm.leafletMap().removeLayer(layer);
            }
        });
        //load gpx

        var gpx_file = vm.session_tmp() +'files/'+ vm.gpx_file_name(); 
        var gpxLayer = new L.GPX(gpx_file, {
            async: true,
            marker_options: {
            startIconUrl: 'http://github.com/mpetazzoni/leaflet-gpx/raw/master/pin-icon-start.png',
            endIconUrl:   'http://github.com/mpetazzoni/leaflet-gpx/raw/master/pin-icon-end.png',
            shadowUrl:    'http://github.com/mpetazzoni/leaflet-gpx/raw/master/pin-shadow.png',
          },
        }).on('loaded', function(e) {

            // var elt = document.getElementById('plotdiv')
            // function _t(t) { return elt.getElementsByTagName(t)[0]; }
            // function _c(c) { return elt.getElementsByClassName(c)[0]; }

            vm.leafletMap().fitBounds(e.target.getBounds());
            var gpx = e.target;
            
            vm.gpxjs_vars({
                get_name: gpx.get_name(),//returns the name of the GPX track
                pace: gpx.get_duration_string(gpx.get_moving_pace_imp(), true),
                get_distance_imp: gpx.get_distance_imp().toFixed(2),//returns the total track distance in miles
                get_start_time: gpx.get_start_time().toDateString() + ', '+ gpx.get_start_time().toLocaleTimeString(),//returns a Javascript Date object representing the starting time
                get_start_date: gpx.get_start_time().toDateString(),
                get_moving_time: msToTime(gpx.get_moving_time()),//returns the moving time, in milliseconds
                get_total_time: msToTime(gpx.get_total_time()),//returns the total track time, in milliseconds
                get_moving_pace_imp: gpx.get_moving_pace_imp(),//returns the average moving pace in milliseconds per hour
                get_moving_speed_imp: gpx.get_moving_speed_imp().toFixed(2)+' mph',
                get_total_speed_imp: gpx.get_total_speed_imp().toFixed(2) + ' mph',//returns the average total speed in miles per hour
                get_elevation_min_imp: gpx.get_elevation_min_imp().toFixed(2) + "'",// returns the lowest elevation, in feet
                get_elevation_max_imp: gpx.get_elevation_max_imp().toFixed(2) + "'",// returns the highest elevation, in feet
                get_elevation_gain_imp: gpx.get_elevation_gain_imp().toFixed(2) + "'",// returns the cumulative elevation gain, in feet
                get_elevation_loss_imp: gpx.get_elevation_loss_imp().toFixed(2) + "'",//returns the cumulative elevation loss, in feet
                //full elevation, cadence  data
                elevation_net: gpx.to_ft(gpx.get_elevation_gain() - gpx.get_elevation_loss()).toFixed(0),
                get_elevation_data_imp: gpx.get_elevation_data_imp(),
                get_cadence_data_imp: gpx.get_cadence_data_imp()
            });
            vm.leafletControl().addOverlay(gpx, gpx.get_name());
            // _c('duration').textContent = gpx.get_duration_string(gpx.get_moving_time());
            // _c('pace').textContent     = gpx.get_duration_string(gpx.get_moving_pace_imp(), true);
            // _c('avghr').textContent    = gpx.get_average_hr();
            // _c('elevation-gain').textContent = gpx.to_ft(gpx.get_elevation_gain()).toFixed(0);
            // _c('elevation-loss').textContent = gpx.to_ft(gpx.get_elevation_loss()).toFixed(0);
            // _c('elevation-net').textContent  = gpx.to_ft(gpx.get_elevation_gain()
            // - gpx.get_elevation_loss()).toFixed(0);
        }).addTo(vm.leafletMap());
        map_lock('unlock');
    }

    // Initialize charts
    initLeaflet()//leaflet
    vm.highchart()//highchart

    $(".download").attr("disabled", true);
    $(".download").css("opacity", 0.2);
    $("#session_url").attr("disabled", "disabled");
    $('#plotdiv').css("opacity", 0.2);
    $('#highcharts').css("opacity", 0.2);
    map_lock('lock');

    //automatically upload GPX file on change.
    $("#gpxfile").on("change", function(){

        //verify that a file is selected
        if($("#gpxfile")[0].files[0]){
            clearData();
            $("#successdiv").empty().show();
            $("#errordiv").empty().show();

            //////////////////////////////
            //Upload and validate the data
            //////////////////////////////

        vm.gpx_file_name($("#gpxfile")[0].files[0].name)

            var req = ocpu.call("gpx_validation", {
                gpxfile : $("#gpxfile")[0].files[0]
            }, function(session){
                vm.session_tmp(session.getLoc());

                //retrieve javascript object as json
                session.getObject(function(data)  {
                    vm.rDataOutput(data)
                    updateLeaflet()
                    $("#session_url").removeAttr("disabled");
                    $(".download").css("opacity", 1);
                    $("#session_url").attr("href", session.getLoc()).attr("target","_blank");
                    $('#plotdiv').css("opacity", 1);
                    $('#highcharts').css("opacity", 1);
                    successmsg("GPX file successfully loaded!");
                });

            }).fail(function(jqXHR){
                clearData();
                errormsg(jqXHR.responseText);
            }).always(function(){
                var session_url = document.getElementById("session_url");
                session_url.style.cursor = "pointer";
            });
        }
    });

    ko.applyBindings(vm);

});

</script>

</head>

  <body>
    <header class="masthead" role="banner">
      <strong class="logo">
        <!-- Add logo to this -->
        <img class="logo-img logo-img-small" src="img/logo-small.svg" alt="GPX File Analyzer">
        <img class="logo-img logo-img-big" src="img/logo-small.svg" alt="GPX File Analyzer">
      </strong>
      <h1 class="title">Menu</h1>
      <nav class="nav-wrap" role="navigation">

        <button class="nav-btn" aria-controls="nav" aria-expanded="false"><i class="nav-icon">Toggle Navigation</i></button>
        <ul class="nav" id="nav" aria-hidden="true">
          <li><span class="nav-label"><span class="nav-label-back">GPS</span></span>
            <ol><li><a href="http://robertsellers.ocpu.io/gpxanalysis/www/">GPX Analyzer</a></li></ol>
          </li>
          <li><span class="nav-label"><span class="nav-label-back">MIP</span></span>
            <ol><li><a href="http://azimuth1.ocpu.io/mihptcheck/www/">MIHPT</a></li></ol>
          </li>
          <li><span class="nav-label"><span class="nav-label-back">pointCollect</span></span>
            <ol><li><a href="https://github.com/Azimuth1/pointCollect">pointCollect</a></li></ol>
          </li>
          <li><span class="nav-label"><span class="nav-label-back">Session URL</span></span>
            <ol><li><a id="session_url">View Session</a></li></ol>
          </li>
          <li><span class="nav-label"><span class="nav-label-back">Credits</span></span>
              <ol><li>by <a href="http://www.azimuth1.com">Azimuth1</a></li></ol>
            </li>
        </ul>
      </nav>
    </header>
  
    <main role="main">

      <article class="panel">
        <h2 class="panel-head section-label" tabindex="0"><span class="section-label-back">Input</span></h2>
          <!-- Step 1: Load File -->
            <form enctype="multipart/form-data" id="uploadform" name="uploadform" role="form">
            <fieldset id="step_1">
              <legend>Load GPX data</legend>
              <div class="form-group">
                <div class="loadFileContainer">
                <input id="gpxfile" type="file" style="display: inline-block;">
                <img src="./img/h6viz.gif" alt="spinner" class="spinLoad" style="width:22px;height:22px;float:right; display: none; vertical-align: top;">
              </div>
              </div>
            </fieldset>
            <!-- R Relayed Message and spinLoad Information -->
            <fieldset id="warnings_panel">
                <legend>Warnings/Messages</legend>
                <div id="successdiv"></div>
                <div id="errordiv"></div>
            </fieldset>
          </td></table>
          </form>

          <article class="panel" style="width:100%;">
      
            <div class="tab-group">
              <ul class="tabs clearfix" role="tablist">
                <li class="tab" role="presentation"><a href="#highcharts" role="tab" aria-selected="true" aria-controls="highcharts">Chart</a></li>
                <li class="tab" role="presentation"><a href="#statistics" role="tab" aria-controls="statistics">Statistics</a></li>
                <li class="tab" role="presentation"><input type="button" class="download" data-bind="click: downloadCSV" value="Download CSV" /></li>
              </ul>
      
              <div class="tab-panels">
                    <div class="tab-panel" id="highcharts" role="tabpanel" aria-hidden="false">
                        <div id="container"></div>
                    </div>
                    <div class="tab-panel" id="statistics" role="tabpanel" aria-hidden="true">
                        <div class='gpx_statistics'>
                            <b>Start date:</b> <span data-bind="text: gpxjs_vars().get_start_date"></span><br>
                            <b>Start time:</b> <span data-bind="text: gpxjs_vars().get_start_time"></span><br>
                            <b>Distance:</b> <span data-bind="text: gpxjs_vars().get_distance_imp"></span><br>
                            <b>Pace:</b> <span data-bind="text: gpxjs_vars().pace"></span><br>
                            <b>Moving Time:</b> <span data-bind="text: gpxjs_vars().get_moving_time"></span><br>
                            <b>Total Time:</b> <span data-bind="text: gpxjs_vars().get_total_time"></span><br>
                            <b>Moving Speed:</b> <span data-bind="text: gpxjs_vars().get_moving_speed_imp"></span><br>
                            <b>Total Speed:</b> <span data-bind="text: gpxjs_vars().get_total_speed_imp"></span><br>
                            <b>Elevation (min):</b> <span data-bind="text: gpxjs_vars().get_elevation_min_imp"></span><br>
                            <b>Elevation (max):</b> <span data-bind="text: gpxjs_vars().get_elevation_max_imp"></span><br>
                            <b>Elevation gain:</b> <span data-bind="text: gpxjs_vars().get_elevation_gain_imp"></span><br>
                            <b>Elevation loss:</b> <span data-bind="text: gpxjs_vars().get_elevation_loss_imp"></span><br>
                        </div>
                        </div>
              </div>
            </div>
      
          </article>
      </article>
      <section id="demo" class="gpx" data-map-target="plotdiv"></section>
      <header>
        <h3 data-bind="text: gpxjs_vars().get_name"></h3>
        <span class="start" data-bind="text: gpxjs_vars().get_start_time"></span>
      </header>
      <article class="panel">
        <h2 class="panel-head section-label" tabindex="0"><span class="section-label-back">GPX Track Map</span></h2>
        <div id="plotdiv" class="map" style="height:600px;"></div>
      </article>
      <footer>
        <ul class="info">
          <li>Distance:&nbsp;<span class="distance" data-bind="text: gpxjs_vars().get_distance_imp"></span>&nbsp;mi</li>
          &mdash; <li>Duration:&nbsp;<span class="duration" data-bind="text: gpxjs_vars().get_moving_time"></span></li>
          &mdash; <li>Pace:&nbsp;<span class="pace" data-bind="text: gpxjs_vars().pace"></span>/mi</li>
          &mdash; <li>Elevation:&nbsp;+<span class="elevation-gain" data-bind="text: gpxjs_vars().get_elevation_gain_imp"></span>&nbsp;ft,
            -<span class="elevation-loss" data-bind="text: gpxjs_vars().get_elevation_loss_imp"></span>&nbsp;ft
            (net:&nbsp;<span class="elevation-net" data-bind="text: gpxjs_vars().elevation_net"></span>&nbsp;ft)</li>
        </ul>
      </footer>
    </main>
    </body>
</html>
