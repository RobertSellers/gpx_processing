<!DOCTYPE html>
<html lang="en">
<head>
<title>GPX QA and Analysis</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- styles -->
<link href="scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="scripts/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" media="screen">
<link href="scripts/jqueryui/css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet" media="screen">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />

<!-- libraries -->
<script src="scripts/jquery-1.10.2.min.js"> </script>
<script src="scripts/opencpu-0.4.js"> </script>
<script src="scripts/bootstrap/js/bootstrap.js"> </script>
<script src="scripts/jqueryui/jquery-ui-1.10.3.custom.js"> </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.3.1/gpx.min.js"></script>

<script type="text/javascript">

$(document).ready(function() {

  var viewModel = {
      session_tmp: ko.observable()
  };

  //Display if dev.html or not
  var cur_url = window.location.href.split(/[\\\/]/)[window.location.href.split(/[\\\/]/).length-1];

  if(cur_url=="dev.html"){
    $("#dev_check").html(cur_url);
  }

  $("#return_metadata").attr("disabled", "disabled");
  $("#plot_map").attr("disabled", "disabled");
  $("#plot_velocity").attr("disabled", "disabled");
  $("#convert_button").attr("disabled", "disabled");
  $("#session_url").attr("disabled", "disabled");

  //automatically upload CSV file on change.
  $("#gpxfile").on("change", function(){

  //verify that a file is selected
  if($("#gpxfile")[0].files[0]){

      $("#successdiv").empty();
      $("#errordiv").empty()

      //////////////////////////////
      //Upload and validate the data
      //////////////////////////////

      var req = ocpu.call("gpx_validation", {
          gpxfile : $("#gpxfile")[0].files[0]
      }, function(session){
          viewModel.session_tmp(session.getLoc())
          $("#session_url").removeAttr("disabled");
          $("#session_url").attr("href", session.getLoc()).attr("target","_blank")
          $("#convert_button").attr("href", session.getLoc())
          $("#convert_button").removeAttr("disabled");
          $("#plot_map").removeAttr("disabled");
          $("#return_metadata").removeAttr("disabled");
          $("#plot_velocity").removeAttr("disabled");
          $("#step_2").css("opacity", 1);
          $("#step_3").css("opacity", 1);
          successmsg("GPX file successfully loaded!");
      }).fail(function(jqXHR){
          $("#step_2").css("opacity", 0.2);
          $("#step_3").css("opacity", 0.2);
          errormsg(jqXHR.responseText);
      }).always(function(){
        var session_url = document.getElementById("session_url");
        session_url.style.cursor = "pointer";
    });
    }
});

//R output to popup
function successmsg(text){
    $("#successdiv").empty().append('<div class="alert alert-success alert-dismissable"><a href="#" class="close" data-dismiss="alert">&times;</a>' + text + '</div>');
}

//R output to popup
function errormsg(text){
    $("#convert_button").attr("disabled", "disabled");
    $("#errordiv").empty().append('<div class="alert alert-danger alert-dismissable"><a href="#" class="close" data-dismiss="alert">&times;</a>' + text + '</div>');
}

$("#return_metadata").on("click", function(){

//////////////////////////////
//Return metadata
//////////////////////////////


    var req = $("#plotdiv").rplot("gpx_extract_metadata", {
      gpxfile : $("#gpxfile")[0].files[0]
    }, function(session){
      //configure inputs on/off
      //success
      $("#session_url").attr("href", session.getLoc()).attr("target","_blank")
      $("#return_metadata").attr("disabled", "disabled");
      $("#convert_button").removeAttr("disabled");
    }).fail(function(jqXHR){
      //failure
      $("#return_metadata").removeAttr("disabled");
      $("#convert_button").attr("disabled", "disabled");
      errormsg(jqXHR.responseText);
     })
});

$("#plot_velocity").on("click", function(){

    //////////////////////////////
    //Plot Preview Velocity
    //////////////////////////////

    //create the plot area on the plotdiv element
    var req = $("#plotdiv").rplot("gpx_plot_velocity", {
      gpxfile : $("#gpxfile")[0].files[0]
    }, function(session){
      //configure inputs on/off
      //success
      $("#session_url").attr("href", session.getLoc()).attr("target","_blank")
      $("#plot_velocity").attr("disabled", "disabled");
      $("#convert_button").removeAttr("disabled");
    }).fail(function(jqXHR){
      //failure
      $("#plot_velocity").removeAttr("disabled");
      $("#convert_button").attr("disabled", "disabled");
      errormsg(jqXHR.responseText);
     })

});

$("#plot_map").on("click", function(){

//////////////////////////////
//Plot Preview Map
//////////////////////////////
  var map = L.map('plotdiv');
  L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="http://www.osm.org">OpenStreetMap</a>'
  }).addTo(map);

  var gpx = $("#gpxfile")[0].files[0]; // URL to your GPX file or the GPX itself

  new L.GPX(gpx, {async: true}).on('loaded', function(e) {
    map.fitBounds(e.target.getBounds());
  }).addTo(map);

});

$("#convert_button").on("click", function(){

//////////////////////////////
//Water level calculations
//////////////////////////////
var req = ocpu.call("gpx_plot_velocity", {
  gpxfile : $("#gpxfile")[0].files[0]
}, function(session){
  //success
  $("#session_url").attr("href", session.getLoc()).attr("target","_blank")
  update_input(session)
  $("#convert_button").attr("disabled", "disabled");
}).fail(function(jqXHR){
   //failure
   $("#convert_button").attr("disabled", "disabled");
   errormsg(jqXHR.responseText);
  })
});


function update_input(session){

    //////////////////////////////
    //Update .zipfile
    //////////////////////////////

    csv_file = session.getLoc()+'R/.val/csv'
    data_file = $("#gpxfile")[0].files[0];
    file_names = session.getLoc()+'files'

}

$(document).ajaxStart(function() {
  $(".progress").show();
});

$(document).ajaxStop(function() {
  $(".progress").hide();
});

});

</script>

<link href="styles/bootstrap_two_panel.css" rel="stylesheet" type="text/css">

</head>

<body>
  <div class="project_wrapper">
    <div class="flex-container">
      <div id="user_input_panel" class="flex-item well">
        <div id="project_title">GPX QA v1.02</div>
        <div id="credits">by <a href="http://www.azimuth1.com">Robert Sellers/Azimuth1</a></div>
        <form role="form" id="uploadform" enctype="multipart/form-data">
          <fieldset id="step_1">
            <legend class="custom_legend">(1) Load GPX data</legend>
              <div class="form-group">
                 <input type="file" id="gpxfile">
              </div>
          </fieldset>
          <fieldset id="step_2">
            <legend class="custom_legend">(2) Next action</legend>
            <div class="form-group">
              <label>View Metadata</label>
              <button id="return_metadata" type="button" disabled="disabled">Click</button><br/>  
              <label>Plot coordinates</label>
              <button id="plot_map" type="button" disabled="disabled">Click</button><br/>
              <label>Plot metrics</label>
              <button id="plot_velocity" type="button" disabled="disabled">Click</button><br/>
              <label>Download as csv</label>
              <button id="convert_button" type="button" disabled="disabled">Click</button>
            </div>
          </fieldset>
        </form>
      <div id='env_wrapper'>
        <a id="session_url">Session URL</a>
        <div id="dev_check"></div>
    </div>
    </div>
    <div id="plotdiv" class="flex-item well"></div>
  </div>
  <!-- R Relayed Message and Progress Information -->
  <div id="azimuth_warning">
      <div id="successdiv"></div>
      <div id="errordiv"></div>
      <div class="progress progress-striped active">
        <div class="progress-bar" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
      </div>
    </div>
  </div>
</body>
</html>
